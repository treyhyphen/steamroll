<!doctype html>
<html lang="en">
    <head>
        <title>Steamroll {% if profile %}{{profile}}{% endif %}</title>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Site icons -->
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#1b2837">
        <meta name="msapplication-TileColor" content="#1b2837">
        <meta name="theme-color" content="#1b2837">

        <!-- OpenGraph Social Preview stuff-->
        <meta property="og:type" content="website" />
        <meta property="og:title" content="Steamroll" />
        <meta property="og:description" content="Your Steam library is massive thanks to bundles. Decision paralysis is real. Get told a random game from your library to play." />
        <meta property="og:url" content="https://steamroll.in" />
        <meta property="og:site_name" content="Steamroll" />

        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:description" content="Your Steam library is massive thanks to bundles. Decision paralysis is real. Get told a random game from your library to play." />
        <meta name="twitter:title" content="Steamroll" />

        <meta property="og:image" content="{{g.base_url}}/social_preview.jpg" />
        <meta name="twitter:image" content="{{g.base_url}}/social_preview.jpg" />

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

        <!-- Font awesome -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

        <!-- noUiSlider -->
        <link href="https://c.all-n.io/nouislider-14.6.3/nouislider.min.css" rel="stylesheet">
        <script src="https://c.all-n.io/nouislider-14.6.3/nouislider.min.js"></script>
        <script src="https://c.all-n.io/wNumb-1.2.0/wNumb.min.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-3NNG0LQKG0"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-3NNG0LQKG0');
        </script>

        <!-- Custom stuff -->
        <style>


            body {
                margin-top: 50px;
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
            }

            h1, h2 {
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
                margin-bottom: 10px;
            }

            h1 > img {
                margin-bottom: 15px;
                opacity: 50%;
            }

            h1 > i {
                font-family: serif;
            }

            h1 > small, h2 > small {
                font-size: 50%;
                color: #9e9e9e;
                display: block;
                text-shadow: none;
            }

            .bg-dark {
                background-color: #1b2837 !important;
                color: #fff;
            }

            .form-control, .form-control:focus {
                background-color: rgb(50, 53, 60);
                border-radius: 2px; 
                border: 1px solid #26282D;
                box-shadow: 2px 2px 15px rgba(0, 0, 0, 0.5);
                color: #fff;
            }

            .form-control:disabled,
            .form-control[readonly],
            [disabled] .noUi-handle, [disabled].noUi-handle, [disabled].noUi-target {
                background-color: #222222;
                opacity: 0.5;
                color: #555;
            }

            .btn {
                border-radius: 2px;
            }

            .btn-primary {
                background: linear-gradient( to right, #47bfff 5%, #1a44c2 60%);
                box-shadow: 2px 2px 15px rgba(0, 0, 0, 0.5);
                background-position: 0%;
                background-size: 330% 100%;
            }

            .logo {
                height: 75px;
            }

            .noUi-target {
                margin-top: 10px;
                background-color: rgb(50, 53, 60);
                border-radius: 2px; 
                border: 1px solid #26282D;
                box-shadow: 2px 2px 15px rgba(0, 0, 0, 0.5);
                color: #fff;                
            }

            .noUi-connect {
                background-color: #1a44c2;
            }

            .noUi-handle {
                background-color: #6c757d;
                border-radius: 2px; 
                border: 1px solid #26282D;
                box-shadow: 2px 2px 15px rgba(0, 0, 0, 0.5);
                color: #fff;
            }

            #matches {
                font-family: monospace;
                font-size: 125%;
            }

            .card {
                border: 0;
                min-height: 300px;
                box-shadow: 2px 2px 15px rgba(0, 0, 0, 0.5);
                background: none;
            }

            .card-bg-dark {
                background-color: #232730;
            }

            .game-card {
                background-position: center;
                background-size: cover;
                cursor: pointer;
            }

            .card-footer {
                background-color: rgb(23 26 33 / 0.8);
                width: 100%;
            }

            .modal-content {
                box-shadow: 2px 2px 15px rgba(0, 0, 0, 0.5);
            }

            .modal-header {
                border-bottom: 0;
            }

            .close {
                color: #fff;
            }

            @media (max-width: 540px) {

                h1 {
                    font-size: 2.3em;
                }

                body {
                    margin-top: 25px;
                    font-size: 0.8rem;
                    padding-left: 10px;
                    padding-right: 10px;
                }

				.logo {
					height: 50px;
				}

                .card {
                    min-height: 200px;
                    padding: 0;
                }

                .card.footer {
                    position: absolute;
                    top: 0;
                }
			}

        </style>
    </head>
    <body class="bg-dark">
        <div class="container ">
            <div class="row justify-content-md-center">
                <div class="col-12 col-sm-5">
                    <center><h1><img src="https://steamroll.in/steamroll.svg" class="logo" ><br>STEAM<i>roll</i><small>Roll the dice on your Steam library.</small></h1></center>

                    <br>

                    <form>
                        <div class="form-group">
                            <label>Profile URL or SteamID</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="user" {% if profile %}value="{{profile}}"{% endif %}>
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="button" id="fetch_profile">Fetch Games</button>
                                </div>
                            </div>
                            <small class="form-text text-muted pull-right"><a href="#" class="text-muted" data-toggle="modal" data-target="#help_modal">Do what now <i class="fa fa-question-circle" aria-hidden="true"></i></a></small>
                        </div>

                    </form>

                    <br>
                    <div id="roll_form" style="display: none;">

                        <div class="form-group">
                            <label>Playtime range (hours)</label>
                            <!--input type="range" class="form-control-range" id="playtime_range"-->
                            <div id="slider"></div>
                        </div>
                        <form>
                            <div class="row justify-content-md-center">
                                <div class="col-6 col-sm-4">
                                    <input type="number" class="form-control" placeholder="min" id="playtime_min" min="0.0" max="1000" step="0.1">
                                </div>
                                <div class="col-6 col-sm-4">
                                    <input type="number" class="form-control" placeholder="max" id="playtime_max" min="0.0" max="1000" step="0.1">
                                </div>
                            </div>
                        </form>

                        <br>

                        <center><button class="btn btn-primary" style="min-width: 200px" id="roll"><i class="fa fa-cube"></i> Roll a <span class="badge badge-light" id="matches">0</span> Sided Die</button></center>

                        <br><br>

                        <span id="name"></span>

                        <div class="card game-card">
                            <div class="card-body" style="min-height: 200px;"></div>
                            <div class="card-footer">
                                <h2 id="game_name"></h2>
                            </div>
                            
                        </div>

                        <br><br>
                                            
                        <center class="text-muted">Like this thing?<br><a href="https://www.buymeacoffee.com/treyhyphen" target="_blank" class="btn btn-secondary btn-sm">☕ Buy Me a Coffee!</a></center>

                        <br><br>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal -->
        <div class="modal fade" id="help_modal" tabindex="-1" role="dialog"aria-hidden="true" style="padding-left: 0;">
            <div class="modal-dialog " role="document">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">HALP! WAT DO?</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                    </div>
                    <div class="modal-body">

                        <a href="#" id="a_help_url" data-controls="#div_help_url">Finding Profile URL</a><br>
                        <a href="#" id="a_help_privacy" data-controls="#div_help_privacy">Profile Not Found</a><br>
                        <a href="#" id="a_help_playtime" data-controls="#div_help_playtime">No Playtime for Games</a>

                        <br><br>

                        <div id="div_help_url">
                            <p>If you don't know your SteamID, you can simply just paste in your profile URL.</p>
                            <p>Click on your name in the upper-right corner of the Steam Desktop client, and select "View Profile".</p>
                            <img src="https://ch3302files.storage.live.com/y4mJvG8a24NftvvFJgmEH7vvdi-93nbnGhVdA18Ui8Z8a_JOrXJ9n3T2s5J2OhJZzWSW0YCBqgjOqxH2Y42AuKqYg3yzZA0U5uxLrQy7YtPHhbGi6VJH5wJOaKx_u52vb-fCItryQ_rZP5r_9SQQkc2QMIXVMf0Wp2KRY2yZU98G6pmm1RTq0VzpPo_YzD4cb7x?width=262&height=167&cropmode=none">
                            <br><br>
                            <p>Once you're on your profile page, just right click literally anywhere on the page and select "Copy Page URL".</p>
                            <img src="https://ch3302files.storage.live.com/y4mw9QE5lbCLmErFHM-1_d8GSen8hTu1TT4cqAUZ1zlkn5ZAFD9bjKF3JQWJjIDBz4PtXNruYLyXtlgr38yvApqqvszLWDVuN-1mrXMYUcEGHD_WkeSnaMkb_RHldjs0z-Zx5tOFM-5ntovggcwlJs_pWZ29DGKfc0bhKsm5EtS-M0DhnBEZrsClPsoii0pBWuT?width=262&height=198&cropmode=none">
                        </div>

                        <div id="div_help_privacy" style="display: none;">
                            <p>If you know you have the right ID or URL, your profile might be set to private at some level.</p>
                            <p>To fix this, go to your profile and click the EDIT button on the upper right side, below your steam level:</p>
                            <img src="https://ch3302files.storage.live.com/y4mvWqEuTz8oClNtJvmvwNWnc-VuJ9AtC3YKo6fEUTfZL_Cb5WRxgJcompROzHUHkLafvaegKw99NLodZk6VhtYI49Sh8GVJ4el_xbjkaQIztj3molmakInCBhiPbD_hWYDIUY-44KXhMKSxXPWWXYnsGEIC8YWNVrfQYc-nvYkYwS8trn3J9cEaFvRr6DzPxNr?width=262&height=177&cropmode=none">
                            <br><br>
                            <p>Click "Privacy Settings" at the bottom of the left-side menu and make sure "My profile" and "Game details" are set to "Public"</p>
                            <img src="https://ch3302files.storage.live.com/y4mKHLVvdNs-RfLv_sgJYZMzIt24pv601bYm6vVcKLU6-cgNt30BEdJV5rp4V-4zShsTLaaccsD-tAEjyWFPiPn1qD_oEBq0UvaqbqWGyfpYx643-ZgTCKjqEe4m3ydqWF4LgPKMLhaLMs6AX9_lzjJkElu8uiObMq-vLTD-WW-ZrgQXjbPWmTSdVCFKXYS1-wl?width=262&height=136&cropmode=none">
                        </div>

                        <div id="div_help_playtime" style="display: none;">
                            <p>If games appear to load, but no playtime is showing and the range inputs are disabled, you are probably hiding total playtime in your profile privacy settings.</p>
                            <p>To fix this, go to your profile and click the EDIT button on the upper right side, below your steam level:</p>
                            <img src="https://ch3302files.storage.live.com/y4mvWqEuTz8oClNtJvmvwNWnc-VuJ9AtC3YKo6fEUTfZL_Cb5WRxgJcompROzHUHkLafvaegKw99NLodZk6VhtYI49Sh8GVJ4el_xbjkaQIztj3molmakInCBhiPbD_hWYDIUY-44KXhMKSxXPWWXYnsGEIC8YWNVrfQYc-nvYkYwS8trn3J9cEaFvRr6DzPxNr?width=262&height=177&cropmode=none">
                            <br><br>
                            <p>Click "Privacy Settings" at the bottom of the left-side menu and make sure the "Always keep my total playtime private..." checkbox under "Game details" is NOT checked:</p>
                            <img src="https://ch3302files.storage.live.com/y4mwM_buP6ltLIrCIAzyFVYJT3tsRg0qs5AYetBQrZ584BngUAu2f0JcgGwRrM5cVtdSdiyRP2AGoF3FI17B5UrhrRRDD9AULm9G-ilcUkcgXTlo36H7A-wYwD9_r_xlzIUVRdjhuKzUMnckwVuaDzuPOgOET3eFHb4ODkcnQVtJPZTTZxs4ByPJFG8-8vomLDR?width=262&height=122&cropmode=none">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

        <script>

            var all_games = [];
            var game_selections = [];
            var image_test_result = false;
            var slider = document.getElementById('slider');

            // Create noUiSlider
            noUiSlider.create(slider, {
                start: [1,100],
                connect: true,
                range: {
                    'min': 0,
                    'min': 0,
                    '25%': 1,
                    '50%': 10,
                    '75%': 100,  
                    'max': 1000
                },
                format: wNumb({decimals: 1}),
                step: 0.1
            });

            // Handle help section clicks
            $('a[id^=a_help]').click(function () {
                console.log($(this).data('controls'));
                $('div[id^=div_help]').css('display', 'none');
                $($(this).data('controls')).css('display', 'block');
            });

            // Capture ENTER key being pressed on the profile fetch input
            // So we properly submit since this isn't a real form
            $('#user').on("keypress", function(e) {
                /* ENTER PRESSED*/
                if (e.keyCode == 13) {
                    e.preventDefault();
                    $('#fetch_profile').click();
                }
            });

            //
            // Magic for fetching profile ... 
            //
            $('#fetch_profile').click(function () {
                var url_id;

                // If we have a URL input, trim all but the last portion of the URL
                if ($('#user').val().startsWith('http')) {
                    url_parts = $('#user').val().split('/');
                    console.log(url_parts);

                    url_id = url_parts[url_parts.length - 1]
                    if (!url_id) {
                        // In case URL ends with a slash .. 
                        url_id = url_parts[url_parts.length - 2]
                    }

                    $('#user').val(url_id);
                }

                // Hit API method to pull games/profile info
                $.get('{{g.base_url}}/games/' + $('#user').val(), function (data) {
                        
                    // Do some visual updates to buttons
                    $('#fetch_profile').removeClass('btn-primary');
                    $('#fetch_profile').addClass('btn-secondary');
                    $('#roll_form').css('display', 'block');

                    // Convert playtime to hours
                    max_hours = Math.ceil(data.games.max_playtime / 60);

                    $('#playtime_min').attr({
                        'min': 0.0,
                        'max': max_hours
                    });

                    $('#playtime_max').attr({
                        'min': 0.0,
                        'max': max_hours
                    });

                    if (max_hours) {
                        slider.noUiSlider.updateOptions({
                            start: [1,100],
                            range: {
                                'min': 0,
                                '25%': 1,
                                '50%': 10,
                                '75%': 100,                            
                                'max': max_hours
                            }
                        });
                        slider.removeAttribute('disabled');
                        $("#playtime_min").prop("disabled", false);
                        $("#playtime_max").prop("disabled", false);                        
                    } else {
                        // if max_hours == 0 disable the slider and inputs
                        // This will happen when the user has a public game list, but is hiding playtime
                        slider.noUiSlider.updateOptions({
                            start: [1,100],
                            range: {
                                'min': 0,
                                '25%': 1,
                                '50%': 10,
                                '75%': 100,                            
                                'max': 1000
                            }
                        });
                        slider.setAttribute('disabled', true);
                        $("#playtime_min").prop("disabled", true);
                        $("#playtime_max").prop("disabled", true);
                    }

                    // Load up all the games so they're accessible to other functions
                    all_games = data.games.games;

                    // Set default noUiSlider values
                    slider.noUiSlider.set([0,max_hours]);

                    // Show profile name so user knows we pulled the right profile
                    $('#name').html(data.profile.personaname + ' rolled:')

                    // Parse out the profile URL to get the ID or Vanity URL portion
                    profileurl_parts = data.profile.profileurl.split('/');
                    profile = profileurl_parts[profileurl_parts.length - 1];
                    if (!profile) {
                        profile = profileurl_parts[profileurl_parts.length - 2];
                    }

                    // Update the input box and URL so user has a clean URL to bookmark to their profile
                    $('#user').val(profile);
                    history.pushState({'id': 'homepage'}, 'Steamroll ' + data.profile.personaname, '/' + profile);

                    $('title').html('Steamroll ' + data.profile.personaname);

                    // Go ahead and perform the first roll
                    $('#roll').click();
                }).fail(function () {
                    alert('Could not find profile');
                    window.location.href = '/';
                });

            });

            // On page load, if we already have a value populated in the input box
            // (like if URL path is set to a profile name/id) .. then go ahead and fetch
            if ($('#user').val()) {
                $('#fetch_profile').click();
            }

            // If we change the value of the MIN input box, set the LEFT handle value on the slider
            $('#playtime_min').change(function () {
                var min_val = parseFloat($(this).val());
                var max_val = parseFloat($('#playtime_max').val());

                // Make sure MIN is never greater than MAX
                if (min_val > max_val) {
                    $(this).val(max_val);
                }

                slider.noUiSlider.set([$(this).val(), null]);
            });

            // If we change the MAX input box, set the RIGHT handle value on the slider
            $('#playtime_max').change(function () {
                var min_val = parseFloat($('#playtime_min').val());
                var max_val = parseFloat($(this).val());

                // Make sure MAX is never less than MIN
                if (max_val < min_val) {
                    $(this).val(min_val);
                }

                slider.noUiSlider.set([null, max_val]);
            });

            // If we change the slider, make sure min/max inputs are updated
            // Also update the selected games within the range via update_selections()
            slider.noUiSlider.on('update', function (values, handle) {
                var value = values[handle];

                if (handle) {
                    $('#playtime_max').val(value);
                } else {
                    $('#playtime_min').val(value);
                }

                selections = update_selections();
            });

            // 
            // Magic for rolling random games out of our selected range
            //
            $('#roll').click(function () {

                // More for smaller, mobile experience .. gently scroll to the roll form
                // So that the game card (hopefully) fits on the screen
                $('html, body').animate({
                    scrollTop: $('#roll_form').offset().top
                }, 800);

                game = game_selections[Math.floor(Math.random() * game_selections.length)];
                console.log(game);

                // Get hours/minutes this game has been played
                hours = Math.floor(game.playtime_forever / 60);
                minutes = game.playtime_forever - (hours * 60);

                // Set Store URL the card will link to
                $('.game-card').data('href', 'https://store.steampowered.com/app/' + game.appid);

                // Display playtime
                $('#game_name').html(game.name + '<small><i class="fa fa-clock-o" aria-hidden="true"></i> ' + hours + ' hours, ' + minutes + ' minutes</small>');

                // Try to load a hero image or a header.jpg
                // testImage() will basically try to fetch the image and return whether or not it failed
                // Sometimes library_hero.jpg won't exist .. if not, fail back to using header.jpg
                if (game.img_logo_url) {
                    url = 'https://cdn.cloudflare.steamstatic.com/steam/apps/' + game.appid + '/library_hero.jpg';

                    testImage(url).then(

                        function fulfilled(img) {
                            $('.game-card').css('background-image', 'url(' + url + ')');
                            console.log('That image is found and loaded', img);
                        },

                        function rejected() {
                            url = 'https://cdn.cloudflare.steamstatic.com/steam/apps/' + game.appid + '/header.jpg';
                            $('.game-card').css('background-image', 'url(' + url + ')');
                            console.log('That image was not found');
                        }

                    );                       
                }

                // Kinda same thing as block above. page_bg_generated_v6b.jpg is a blue-tinted, muted background that gets
                // Displayed on Steam store pages. But sometimes it doesn't exist. Try to fetch it, but if it fails, 
                // just use background-image: none;
                cover_url = 'https://steamcdn-a.akamaihd.net/steam/apps/' + game.appid + '/page_bg_generated_v6b.jpg';
                testImage(cover_url).then(

                    function fulfilled(img) {
                        $('body').css('background-image', 'url(' + cover_url + ')');
                        console.log('That image is found and loaded', img);
                    },

                    function rejected() {
                        $('body').css('background-image', 'none');
                        console.log('That image was not found');
                    }

                );   

                
            });

            // Click handler for game card to take you to Steam store page
            $('.game-card').click(function () {
                window.open($(this).data('href'));
            });

            //
            // This will basically populate the global game_selections array based on the specified playtime range
            //
            function update_selections() {
                game_selections = [];
                $.each(all_games, function (idx, game) {
                    if (game.playtime_forever >= $('#playtime_min').val() * 60 && game.playtime_forever <= $('#playtime_max').val() * 60) {
                        game_selections.push(game);
                    }
                });
                console.log(game_selections);
                $('#matches').html(game_selections.length);
                return game_selections.length;
            }

            //
            // Promise solution for testing whether an image URL actually returns an image
            // Credit to https://stackoverflow.com/a/39574351 for this solution
            //
            function testImage(url) {

                // Define the promise
                const imgPromise = new Promise(function imgPromise(resolve, reject) {

                    // Create the image
                    const imgElement = new Image();

                    // When image is loaded, resolve the promise
                    imgElement.addEventListener('load', function imgOnLoad() {
                        resolve(this);
                    });

                    // When there's an error during load, reject the promise
                    imgElement.addEventListener('error', function imgOnError() {
                        reject();
                    })

                    // Assign URL
                    imgElement.src = url;

                });

                return imgPromise;
            }

            
        </script>
    </body>
</html>